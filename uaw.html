
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡åä¹¦å†™ç»ƒä¹ </title>
    <!-- å¼•å…¥ Noto Sans JP å­—ä½“ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/earlyaccess/kokoro.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/earlyaccess/hannari.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@200&display=swap" rel="stylesheet">
    <style>
        /* å…¨å±€å­—ä½“è®¾ç½®ä¸º Noto Sans JP */
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            font-family: "Kokoro", sans-serif;
            font-optical-sizing: auto;
            font-weight: 200;
            font-style: normal;
            touch-action: none; /* ç¦æ­¢é»˜è®¤è§¦æ‘¸è¡Œä¸º */
        }

        #canvas {
            border: 1px solid #000;
            background-color: #fff;
            margin-bottom: 20px;
            touch-action: none; /* ç¦æ­¢é»˜è®¤è§¦æ‘¸è¡Œä¸º */
            cursor: default; /* ä¿®å¤åå­—å…‰æ ‡é—®é¢˜ */
        }

        #settings-menu {
            display: none;
            position: absolute;
            top: 60px;
            right: 20px;
            background-color: white;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            min-width: 300px;
            z-index: 1000;
        }

        .settings-section {
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .settings-section-title {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .kana-type-options {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 40px;  /* å¢åŠ åº•éƒ¨é—´è· */
        }

        #kana-history {
            font-size: 24px;
            margin: 30px 0;  /* å¢åŠ ä¸Šä¸‹é—´è· */
            padding: 15px;   /* å¢åŠ å†…éƒ¨é—´è· */
            text-align: center;
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            max-width: 800px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            backdrop-filter: blur(5px);
        }

        button {
            padding: 10px 20px;
            font-size: 24px;
            cursor: pointer;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
        }

        button:hover {
            background-color: #0056b3;
        }

        #romaji {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        #kana-history {
            font-size: 24px;
            margin-bottom: 10px;
            text-align: center;
            display: flex;
            gap: 5px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .kana-block {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            margin: 4px;
            background-color: #ffffff;
            border-radius: 8px;
            cursor: pointer;
            min-width: 30px;
            min-height: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            font-size: 20px;
        }

        .kana-block:hover {
            background-color: #f8f8f8;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        .practice-link {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            backdrop-filter: blur(5px);
            text-decoration: none;
            color: #666;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .practice-link:hover {
            background-color: rgba(255, 255, 255, 0.8);
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        #kana-history {
            font-size: 24px;
            margin: 20px 0;
            padding: 10px;
            text-align: center;
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            max-width: 800px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            backdrop-filter: blur(5px);
        }
        /* ç‰ˆæœ¬å· */
        .version {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 12px;
            color: #666;
            z-index: 100;
        }
        .tooltip {
            position: absolute;
            top: 45px;
            right: 80px;
            background-color: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            white-space: nowrap;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -6px;
            transform: translateY(-50%);
            border-width: 6px 0 6px 6px;
            border-style: solid;
            border-color: transparent transparent transparent #333;
        }

        #settings-icon {
            position: absolute;
            top: 35px;
            right: 35px;
            font-size: 35px;
            cursor: pointer;
        }

        #settings-menu {
            display: none;
            position: absolute;
            top: 60px;
            right: 20px;
            background-color: white;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #settings-menu label {
            display: block;
        }

        #settings-menu input[type="range"] {
            width: 100%;
        }

        .inline {
            display: flex;
            align-items: center;
            gap: 10px;
            min-height: 32px;
        }

        .inline label {
            display: flex;
            align-items: center;
            margin-bottom: 0;
            min-height: 24px;
        }

        .inline input[type="checkbox"] {
            margin: 0;
            width: 16px;
            height: 16px;
            vertical-align: middle;
        }

        .inline select {
            padding: 8px 32px 8px 12px;
            border-radius: 6px;
            border: 1px solid #ccc;
            background-color: #fff;
            font-size: 14px;
            color: #333;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .inline select:hover {
            border-color: #666;
        }

        .inline select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }

        .kana-groups {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 10px;
            max-width: 500px;
        }

        .kana-groups label {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            padding: 8px;
            border-radius: 4px;
            background-color: #f8f8f8;
            min-height: 24px;
        }

        .kana-groups input[type="checkbox"] {
            margin: 0;
            vertical-align: middle;
        }
        /* æœ€è¿‘å‡ºç°çš„å‡åæç¤ºæ°”æ³¡æ ·å¼ */
        .romaji-tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 16px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        @media (max-width: 600px) {
            .kana-groups {
                grid-template-columns: repeat(3, 1fr);
            }
            /* 
            .buttons {
                flex-direction: column;
            }
            */
        }


    </style>
</head>
<body>
    <div id="romaji"></div>
    <canvas id="canvas" width="200" height="200"></canvas>
    <div class="buttons">
        <button id="speak-again">ğŸ“¢</button>
        <button id="eraser">âŒ</button>
        <button id="next">â­•ï¸</button>
    </div>
    <div id="kana-history"></div><!-- è®°å½•æœ€å 10 ä¸ªå‡å -->
    <a href="/dictation.html" class="practice-link">çœ‹éŸ³å†™å‡å</a> 

    <!-- é½¿è½®å›¾æ ‡ -->
    <div id="settings-icon">ğŸ”§</div>

    <!-- è®¾ç½®èœå• -->
    <div id="settings-menu">
        <div class="settings-section">
            <div class="settings-section-title">å‡ºç°æ¨¡å¼</div>
            <div class="inline">
                <select id="practice-type">
                    <option value="mixed">æ··åˆæ¨¡å¼</option>
                    <option value="hiragana">å¹³å‡å</option>
                    <option value="katakana">ç‰‡å‡å</option>
                </select>
            </div>
        </div>
    
        <div class="settings-section">
            <div class="settings-section-title">é™åˆ¶æ¨¡å¼</div>
            <div class="inline">
                <input type="checkbox" id="learning-mode">
                <label for="learning-mode">å¯ç”¨é™åˆ¶æ¨¡å¼</label>
            </div>
            <div id="kana-groups-container" style="display: none;">

                <div class="kana-groups">
                    <!-- å‡ååˆ†ç»„å¤é€‰æ¡†å°†é€šè¿‡ JavaScript åŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-section-title">æµ‹è¯•æ¨¡å¼</div>
            <div class="inline">
                <input type="checkbox" id="test-mode">
                <label for="test-mode">å¯ç”¨æ‹¼è¯»æµ‹è¯•</label>
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-section-title">æ˜¾ç¤ºè®¾ç½®</div>
            <div class="inline">
                <label for="show-romaji">æ˜¾ç¤ºç½—é©¬éŸ³ï¼š</label>
                <input type="checkbox" id="show-romaji" checked>
            </div>
            <div class="inline">
                <label for="speak">æœ—è¯»å‡åï¼š</label>
                <input type="checkbox" id="speak" checked>
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-section-title">å­—ä½“è®¾ç½®</div>
            <div class="inline">
                <label for="font-select">é€‰æ‹©å­—ä½“ï¼š</label>
                <select id="font-select">
                    <option value="Kokoro">Kokoro</option>
                    <option value="Hannari">Hannari</option>
                    <option value="Noto Sans JP">Noto Sans JP</option>
                </select>
            </div>
            <label for="opacity">å‡åé€æ˜åº¦ï¼š<span id="opacity-value">20</span>%</label>
            <input type="range" id="opacity" min="0" max="100" value="20">
            <div class="inline">
                <label for="color">å‡åé¢œè‰²ï¼š</label>
                <input type="color" id="color" value="#000000">
            </div>
        </div>
    </div>
    <div class="version">ver.0.2.6</div>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const romajiDisplay = document.getElementById('romaji');
        const kanaHistoryDisplay = document.getElementById('kana-history');
        const settingsIcon = document.getElementById('settings-icon');
        const settingsMenu = document.getElementById('settings-menu');
        const practiceTypeSelect = document.getElementById('practice-type');
        const learningModeCheckbox = document.getElementById('learning-mode');
        const kanaGroupsContainer = document.getElementById('kana-groups-container');
        const opacityInput = document.getElementById('opacity');
        const opacityValue = document.getElementById('opacity-value');
        const colorInput = document.getElementById('color');
        const speakCheckbox = document.getElementById('speak');
        const fontSelect = document.getElementById('font-select');

        // ç”°å­—æ ¼çš„å¤§å°
        const gridSize = 200;
        const cellSize = gridSize / 2;

        // å¹³å‡åå’Œç‰‡å‡åæ•°ç»„
        const hiragana = [
            'ã‚', 'ã„', 'ã†', 'ãˆ', 'ãŠ',
            'ã‹', 'ã', 'ã', 'ã‘', 'ã“',
            'ã•', 'ã—', 'ã™', 'ã›', 'ã',
            'ãŸ', 'ã¡', 'ã¤', 'ã¦', 'ã¨',
            'ãª', 'ã«', 'ã¬', 'ã­', 'ã®',
            'ã¯', 'ã²', 'ãµ', 'ã¸', 'ã»',
            'ã¾', 'ã¿', 'ã‚€', 'ã‚', 'ã‚‚',
            'ã‚„', 'ã‚†', 'ã‚ˆ',
            'ã‚‰', 'ã‚Š', 'ã‚‹', 'ã‚Œ', 'ã‚',
            'ã‚', 'ã‚’', 'ã‚“'
        ];
        const katakana = [
            'ã‚¢', 'ã‚¤', 'ã‚¦', 'ã‚¨', 'ã‚ª',
            'ã‚«', 'ã‚­', 'ã‚¯', 'ã‚±', 'ã‚³',
            'ã‚µ', 'ã‚·', 'ã‚¹', 'ã‚»', 'ã‚½',
            'ã‚¿', 'ãƒ', 'ãƒ„', 'ãƒ†', 'ãƒˆ',
            'ãƒŠ', 'ãƒ‹', 'ãƒŒ', 'ãƒ', 'ãƒ',
            'ãƒ', 'ãƒ’', 'ãƒ•', 'ãƒ˜', 'ãƒ›',
            'ãƒ', 'ãƒŸ', 'ãƒ ', 'ãƒ¡', 'ãƒ¢',
            'ãƒ¤', 'ãƒ¦', 'ãƒ¨',
            'ãƒ©', 'ãƒª', 'ãƒ«', 'ãƒ¬', 'ãƒ­',
            'ãƒ¯', 'ãƒ²', 'ãƒ³'
        ];

        // å¹³å‡åå’Œç‰‡å‡åå¯¹åº”çš„ç½—é©¬éŸ³
        const romaji = {
            'ã‚': 'a', 'ã„': 'i', 'ã†': 'u', 'ãˆ': 'e', 'ãŠ': 'o',
            'ã‹': 'ka', 'ã': 'ki', 'ã': 'ku', 'ã‘': 'ke', 'ã“': 'ko',
            'ã•': 'sa', 'ã—': 'shi', 'ã™': 'su', 'ã›': 'se', 'ã': 'so',
            'ãŸ': 'ta', 'ã¡': 'chi', 'ã¤': 'tsu', 'ã¦': 'te', 'ã¨': 'to',
            'ãª': 'na', 'ã«': 'ni', 'ã¬': 'nu', 'ã­': 'ne', 'ã®': 'no',
            'ã¯': 'ha', 'ã²': 'hi', 'ãµ': 'fu', 'ã¸': 'he', 'ã»': 'ho',
            'ã¾': 'ma', 'ã¿': 'mi', 'ã‚€': 'mu', 'ã‚': 'me', 'ã‚‚': 'mo',
            'ã‚„': 'ya', 'ã‚†': 'yu', 'ã‚ˆ': 'yo',
            'ã‚‰': 'ra', 'ã‚Š': 'ri', 'ã‚‹': 'ru', 'ã‚Œ': 're', 'ã‚': 'ro',
            'ã‚': 'wa', 'ã‚’': 'wo', 'ã‚“': 'n',
            'ã‚¢': 'a', 'ã‚¤': 'i', 'ã‚¦': 'u', 'ã‚¨': 'e', 'ã‚ª': 'o',
            'ã‚«': 'ka', 'ã‚­': 'ki', 'ã‚¯': 'ku', 'ã‚±': 'ke', 'ã‚³': 'ko',
            'ã‚µ': 'sa', 'ã‚·': 'shi', 'ã‚¹': 'su', 'ã‚»': 'se', 'ã‚½': 'so',
            'ã‚¿': 'ta', 'ãƒ': 'chi', 'ãƒ„': 'tsu', 'ãƒ†': 'te', 'ãƒˆ': 'to',
            'ãƒŠ': 'na', 'ãƒ‹': 'ni', 'ãƒŒ': 'nu', 'ãƒ': 'ne', 'ãƒ': 'no',
            'ãƒ': 'ha', 'ãƒ’': 'hi', 'ãƒ•': 'fu', 'ãƒ˜': 'he', 'ãƒ›': 'ho',
            'ãƒ': 'ma', 'ãƒŸ': 'mi', 'ãƒ ': 'mu', 'ãƒ¡': 'me', 'ãƒ¢': 'mo',
            'ãƒ¤': 'ya', 'ãƒ¦': 'yu', 'ãƒ¨': 'yo',
            'ãƒ©': 'ra', 'ãƒª': 'ri', 'ãƒ«': 'ru', 'ãƒ¬': 're', 'ãƒ­': 'ro',
            'ãƒ¯': 'wa', 'ãƒ²': 'wo', 'ãƒ³': 'n'
        };

        // å‡ååˆ†ç»„
        const kanaGroups = {
            'ã‚è¡Œ': ['ã‚', 'ã„', 'ã†', 'ãˆ', 'ãŠ'],
            'ã‹è¡Œ': ['ã‹', 'ã', 'ã', 'ã‘', 'ã“'],
            'ã•è¡Œ': ['ã•', 'ã—', 'ã™', 'ã›', 'ã'],
            'ãŸè¡Œ': ['ãŸ', 'ã¡', 'ã¤', 'ã¦', 'ã¨'],
            'ãªè¡Œ': ['ãª', 'ã«', 'ã¬', 'ã­', 'ã®'],
            'ã¯è¡Œ': ['ã¯', 'ã²', 'ãµ', 'ã¸', 'ã»'],
            'ã¾è¡Œ': ['ã¾', 'ã¿', 'ã‚€', 'ã‚', 'ã‚‚'],
            'ã‚„è¡Œ': ['ã‚„', 'ã‚†', 'ã‚ˆ'],
            'ã‚‰è¡Œ': ['ã‚‰', 'ã‚Š', 'ã‚‹', 'ã‚Œ', 'ã‚'],
            'ã‚è¡Œ': ['ã‚', 'ã‚’', 'ã‚“'],
            'ã‚¢è¡Œ': ['ã‚¢', 'ã‚¤', 'ã‚¦', 'ã‚¨', 'ã‚ª'],
            'ã‚«è¡Œ': ['ã‚«', 'ã‚­', 'ã‚¯', 'ã‚±', 'ã‚³'],
            'ã‚µè¡Œ': ['ã‚µ', 'ã‚·', 'ã‚¹', 'ã‚»', 'ã‚½'],
            'ã‚¿è¡Œ': ['ã‚¿', 'ãƒ', 'ãƒ„', 'ãƒ†', 'ãƒˆ'],
            'ãƒŠè¡Œ': ['ãƒŠ', 'ãƒ‹', 'ãƒŒ', 'ãƒ', 'ãƒ'],
            'ãƒè¡Œ': ['ãƒ', 'ãƒ’', 'ãƒ•', 'ãƒ˜', 'ãƒ›'],
            'ãƒè¡Œ': ['ãƒ', 'ãƒŸ', 'ãƒ ', 'ãƒ¡', 'ãƒ¢'],
            'ãƒ¤è¡Œ': ['ãƒ¤', 'ãƒ¦', 'ãƒ¨'],
            'ãƒ©è¡Œ': ['ãƒ©', 'ãƒª', 'ãƒ«', 'ãƒ¬', 'ãƒ­'],
            'ãƒ¯è¡Œ': ['ãƒ¯', 'ãƒ²', 'ãƒ³']
        };

        // å½“å‰æ˜¾ç¤ºçš„å‡å
        let currentKana = '';

        // å‡åé€æ˜åº¦ï¼ˆé»˜è®¤20%ï¼‰
        let kanaOpacity = 0.2;

        // å‡åé¢œè‰²ï¼ˆé»˜è®¤é»‘è‰²ï¼‰
        let kanaColor = '#000000';

        // è®°å½•æœ€å 10 ä¸ªå‡å
        let kanaHistory = [];

        // æ‰€æœ‰å‡åæ•°ç»„
        let allKana = [...hiragana, ...katakana];

        // æ‰“ä¹±æ•°ç»„é¡ºåºï¼ˆFisher-Yates ç®—æ³•ï¼‰
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // æ‰“ä¹±åçš„å‡åæ•°ç»„
        let shuffledKana = shuffleArray(allKana);

        // å½“å‰å‡åç´¢å¼•
        let currentIndex = 0;

        // è®¾ç½®å†å²è®°å½•æœ€å¤§é•¿åº¦
        let maxHistoryLength = window.innerHeight > window.innerWidth ? 6 : 10;

        // æ£€æµ‹è®¾å¤‡æ–¹å‘å¹¶è®¾ç½®å†å²è®°å½•é•¿åº¦
        function setMaxHistoryLength() {
            maxHistoryLength = window.innerHeight > window.innerWidth ? 6 : 10;
            // å¦‚æœå½“å‰å†å²è®°å½•è¶…è¿‡æ–°çš„æœ€å¤§é•¿åº¦ï¼Œåˆ™è£å‰ª
            while (kanaHistory.length > maxHistoryLength) {
                kanaHistory.shift();
            }
            // æ›´æ–°æ˜¾ç¤º
            kanaHistoryDisplay.innerHTML = kanaHistory
                .map(k => `<span class="kana-block">${k}</span>`)
                .join('');
        }

        // é¡µé¢åŠ è½½æ—¶è®¾ç½®å†å²è®°å½•é•¿åº¦
        document.addEventListener('DOMContentLoaded', setMaxHistoryLength);

        // æ›´æ–°å‡åè®°å½•
        function updateKanaHistory(kana) {
            kanaHistory.push(kana);
            if (kanaHistory.length > maxHistoryLength) {
                kanaHistory.shift();
            }
            
            kanaHistoryDisplay.innerHTML = kanaHistory
                .map(k => `<span class="kana-block" data-kana="${k}">${k}</span>`)
                .join('');

            // ä¸ºæ¯ä¸ªå‡åå—æ·»åŠ äº‹ä»¶ç›‘å¬
            document.querySelectorAll('.kana-block').forEach(block => {
                block.addEventListener('mouseenter', showRomajiTooltip);
                block.addEventListener('mouseleave', hideRomajiTooltip);
                block.addEventListener('touchstart', handleTouch);
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨æ’­æ”¾è¯­éŸ³
                block.addEventListener('click', (e) => {
                    const kana = e.target.dataset.kana;
                    speakKana(kana);
                });
            });
        }
        // æ˜¾ç¤ºç½—é©¬éŸ³æ°”æ³¡
        function showRomajiTooltip(e) {
            const kana = e.target.dataset.kana;
            const romajiText = romaji[kana];
            
            // ç§»é™¤å·²å­˜åœ¨çš„æ°”æ³¡
            const existingTooltip = document.querySelector('.romaji-tooltip');
            if (existingTooltip) {
                existingTooltip.remove();
            }

            // åˆ›å»ºæ–°æ°”æ³¡
            const tooltip = document.createElement('div');
            tooltip.className = 'romaji-tooltip';
            tooltip.textContent = romajiText;
            document.body.appendChild(tooltip);

            // è®¡ç®—ä½ç½®
            const rect = e.target.getBoundingClientRect();
            tooltip.style.left = `${rect.left + (rect.width - tooltip.offsetWidth) / 2}px`;
            tooltip.style.top = `${rect.top - tooltip.offsetHeight - 8}px`;

            // æ˜¾ç¤ºæ°”æ³¡
            requestAnimationFrame(() => {
                tooltip.style.opacity = '1';
            });

            // 1ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                tooltip.style.opacity = '0';
                setTimeout(() => tooltip.remove(), 300);
            }, 1000);
        }

        function hideRomajiTooltip() {
            const tooltip = document.querySelector('.romaji-tooltip');
            if (tooltip) {
                tooltip.style.opacity = '0';
                setTimeout(() => tooltip.remove(), 300);
            }
        }

        function handleTouch(e) {
            e.preventDefault();
            showRomajiTooltip(e);
        }

        // æœ—è¯»å‡å
        // è¯­éŸ³åˆæˆé˜Ÿåˆ—
        let speechQueue = [];
        let isSpeaking = false;

        // æœ—è¯»å‡å
           // åˆå§‹åŒ–è¯­éŸ³åˆæˆ
           let voices = [];
        let japaneseVoice = null;

        // ç­‰å¾…è¯­éŸ³åŠ è½½
        function loadVoices() {
            return new Promise((resolve) => {
                voices = speechSynthesis.getVoices();
                if (voices.length > 0) {
                    resolve();
                } else {
                    speechSynthesis.addEventListener('voiceschanged', () => {
                        voices = speechSynthesis.getVoices();
                        resolve();
                    }, { once: true });
                }
            });
        }

        // è·å–æ—¥è¯­è¯­éŸ³
        async function initJapaneseVoice() {
            await loadVoices();
            japaneseVoice = voices.find(voice => voice.lang.includes('ja'));
        }

        // æœ—è¯»å‡å
        async function speakKana(kana) {
            if (!speakCheckbox.checked || !('speechSynthesis' in window)) return;

            try {
                // ç¡®ä¿å·²åŠ è½½æ—¥è¯­è¯­éŸ³
                if (!japaneseVoice) {
                    await initJapaneseVoice();
                }

                // å–æ¶ˆä¹‹å‰çš„è¯­éŸ³
                speechSynthesis.cancel();

                // åˆ›å»ºæ–°çš„è¯­éŸ³å®ä¾‹
                const utterance = new SpeechSynthesisUtterance(kana);
                utterance.voice = japaneseVoice;
                utterance.lang = 'ja-JP';
                utterance.rate = 0.8;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;

                // ä½¿ç”¨ Promise åŒ…è£…è¯­éŸ³æ’­æ”¾
                await new Promise((resolve, reject) => {
                    utterance.onend = resolve;
                    utterance.onerror = reject;
                    speechSynthesis.speak(utterance);//æ”¯æ´Safariçš„å…³é”®æ‰€åœ¨ï¼Ÿ
                });
            } catch (error) {
                console.error('è¯­éŸ³åˆæˆé”™è¯¯:', error);
            }
        }

        // ç»˜åˆ¶ç”°å­—æ ¼
        function drawGrid() {
            ctx.strokeStyle = '#ffb3b3'; // æµ…çº¢è‰²
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]); // è®¾ç½®è™šçº¿æ ·å¼ï¼Œ5åƒç´ çº¿æ®µï¼Œ5åƒç´ é—´éš”

            // ç»˜åˆ¶å¤–æ¡†
            ctx.strokeRect(0, 0, gridSize, gridSize);

            // ç»˜åˆ¶æ¨ªçº¿
            ctx.beginPath();
            ctx.moveTo(0, cellSize);
            ctx.lineTo(gridSize, cellSize);
            ctx.stroke();

            // ç»˜åˆ¶ç«–çº¿
            ctx.beginPath();
            ctx.moveTo(cellSize, 0);
            ctx.lineTo(cellSize, gridSize);
            ctx.stroke();

            // é‡ç½®è™šçº¿æ ·å¼
            ctx.setLineDash([]);
        }

        // ç»˜åˆ¶å‡å
        function drawKana(kana) {
            const selectedFont = fontSelect.value; // è·å–ç”¨æˆ·é€‰æ‹©çš„å­—ä½“
            ctx.font = `200 150px "${selectedFont}", sans-serif`; // ä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„å­—ä½“
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = `rgba(${parseInt(kanaColor.slice(1, 3), 16)}, ${parseInt(kanaColor.slice(3, 5), 16)}, ${parseInt(kanaColor.slice(5, 7), 16)}, ${kanaOpacity})`;
            ctx.fillText(kana, gridSize / 2, gridSize / 2);
        }

        // æ˜¾ç¤ºç½—é©¬éŸ³
        function displayRomaji(kana) {
            romajiDisplay.textContent = romaji[kana] || '';
        }

        // åˆå§‹åŒ–ç”»æ¿
        function init() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // æ¸…ç©ºç”»å¸ƒ
            drawGrid();
            currentKana = shuffledKana[currentIndex]; // è·å–å½“å‰å‡å
            drawKana(currentKana);
            displayRomaji(currentKana);
            updateKanaHistory(currentKana); // æ›´æ–°å‡åè®°å½•
            speakKana(currentKana); // æœ—è¯»å‡å
            currentIndex = (currentIndex + 1) % shuffledKana.length; // æ›´æ–°ç´¢å¼•

            // å¦‚æœæ‰€æœ‰å‡åå·²è¾“å‡ºä¸€æ¬¡ï¼Œé‡æ–°æ‰“ä¹±é¡ºåº
            if (currentIndex === 0) {
                shuffledKana = shuffleArray(allKana);
            }
        }

        // è·å–è§¦æ‘¸ç‚¹çš„åæ ‡
        function getTouchPos(event) {
            const rect = canvas.getBoundingClientRect();
            const touch = event.touches[0];
            return {
                x: touch.clientX - rect.left,
                y: touch.clientY - rect.top
            };
        }

        // é¼ æ ‡å’Œè§¦æ‘¸äº‹ä»¶å¤„ç†
        let isDrawing = false;

        // é¼ æ ‡äº‹ä»¶
        canvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        });

        canvas.addEventListener('mousemove', (e) => {
            if (isDrawing) {
                ctx.lineWidth = 5; // ç”»ç¬”ç²—ç»†
                ctx.strokeStyle = '#000'; // ç”»ç¬”é¢œè‰²
                ctx.lineCap = 'round'; // ç”»ç¬”åœ†æ¶¦
                ctx.lineJoin = 'round'; // è¿æ¥å¤„åœ†æ¶¦
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.stroke();
            }
        });

        canvas.addEventListener('mouseup', () => {
            isDrawing = false;
            ctx.closePath();
        });

        canvas.addEventListener('mouseleave', () => {
            isDrawing = false;
        });

        // è§¦æ‘¸äº‹ä»¶
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
            isDrawing = true;
            const pos = getTouchPos(e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
            if (isDrawing) {
                const pos = getTouchPos(e);
                ctx.lineWidth = 5; // ç”»ç¬”ç²—ç»†
                ctx.strokeStyle = '#000'; // ç”»ç¬”é¢œè‰²
                ctx.lineCap = 'round'; // ç”»ç¬”åœ†æ¶¦
                ctx.lineJoin = 'round'; // è¿æ¥å¤„åœ†æ¶¦
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            }
        });

        canvas.addEventListener('touchend', () => {
            isDrawing = false;
            ctx.closePath();
        });

        // è·å–æ–°å¢çš„æœ—è¯»æŒ‰é’®
        const speakAgainButton = document.getElementById('speak-again');
        // ä¸ºæœ—è¯»æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
        speakAgainButton.addEventListener('click', () => {
            speakKana(currentKana); // é‡æ–°æœ—è¯»å½“å‰å‡å
        });

        // æ©¡çš®æ“¦åŠŸèƒ½ï¼šä»…æ¸…é™¤æç”»å†…å®¹ï¼Œä¸æ›´æ–°å‡å
        document.getElementById('eraser').addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // æ¸…ç©ºç”»å¸ƒ
            drawGrid(); // é‡æ–°ç»˜åˆ¶ç”°å­—æ ¼
            drawKana(currentKana); // é‡æ–°ç»˜åˆ¶å½“å‰å‡å
        });

        // ä¸‹ä¸€ä¸ªå‡ååŠŸèƒ½
        document.getElementById('next').addEventListener('click', () => {
            init(); // é‡æ–°åˆå§‹åŒ–ç”»å¸ƒ
        });

        // è®¾ç½®èœå•æ˜¾ç¤º/éšè—
        settingsIcon.addEventListener('click', (e) => {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            settingsMenu.style.display = settingsMenu.style.display === 'block' ? 'none' : 'block';
        });
    
        // è·å–å…¨é€‰å¤é€‰æ¡†
        const selectAllCheckbox = document.getElementById('select-all');


        // ä¿®æ”¹å‡ååˆ†ç»„å¤é€‰æ¡†çš„å˜åŒ–ç›‘å¬ï¼Œä½¿å…¶åŒæ­¥å…¨é€‰æ¡†çŠ¶æ€
        document.querySelector('.kana-groups').addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.kana-groups input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
            selectAllCheckbox.checked = allChecked;
            updateKanaGroups();
        });

        // ç‚¹å‡»é¡µé¢å…¶ä»–åŒºåŸŸå…³é—­è®¾ç½®èœå•
        document.addEventListener('click', () => {
            settingsMenu.style.display = 'none';
        });

        // é˜»æ­¢è®¾ç½®èœå•å†…éƒ¨çš„ç‚¹å‡»äº‹ä»¶å†’æ³¡
        settingsMenu.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // åŠ è½½å‡ååˆ†ç»„å¤é€‰æ¡†
        function loadKanaGroups() {
            const kanaGroupsDiv = document.querySelector('.kana-groups');
            kanaGroupsDiv.innerHTML = ''; // æ¸…ç©ºé€‰é¡¹
            for (const group in kanaGroups) {
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = group;
                checkbox.checked = true; // é»˜è®¤å…¨é€‰
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(group));
                kanaGroupsDiv.appendChild(label);
            }
        }

        // åˆå§‹åŒ–å‡ååˆ†ç»„å¤é€‰æ¡†
        loadKanaGroups();

        // é™åˆ¶æ¨¡å¼å¼€å…³
        learningModeCheckbox.addEventListener('change', () => {
            kanaGroupsContainer.style.display = learningModeCheckbox.checked ? 'block' : 'none';
            if (!learningModeCheckbox.checked) {
                allKana = [...hiragana, ...katakana]; // é‡ç½®ä¸ºæ‰€æœ‰å‡å
                shuffledKana = shuffleArray(allKana);
                currentIndex = 0;
                init();
            }
        });

        // æ›´æ–°å‡ååˆ†ç»„
        function updateKanaGroups() {
            const selectedGroups = Array.from(document.querySelectorAll('.kana-groups input:checked'))
                .map(checkbox => kanaGroups[checkbox.value])
                .flat();
            allKana = selectedGroups.length > 0 ? selectedGroups : [...hiragana, ...katakana];
            shuffledKana = shuffleArray(allKana);
            currentIndex = 0;
            init();
        }

        // ç›‘å¬å‡ååˆ†ç»„å¤é€‰æ¡†çš„å˜åŒ–
        document.querySelector('.kana-groups').addEventListener('change', updateKanaGroups);

        // è°ƒæ•´ç»ƒä¹ ç±»å‹
        practiceTypeSelect.addEventListener('change', () => {
            const type = practiceTypeSelect.value;
            
            // æ ¹æ®é€‰æ‹©çš„ç±»å‹è®¾ç½®å‡ååˆ—è¡¨
            if (type === 'hiragana') {
                allKana = [...hiragana];
            } else if (type === 'katakana') {
                allKana = [...katakana];
            } else {
                allKana = [...hiragana, ...katakana];
            }

            // æ›´æ–°é™åˆ¶æ¨¡å¼ä¸­çš„é€‰é¡¹
            const checkboxes = document.querySelectorAll('.kana-groups input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                const groupName = checkbox.value;
                const isHiraganaGroup = groupName.match(/^[ã‚-ã‚“]/); // ä½¿ç”¨æ—¥è¯­å­—ç¬¦èŒƒå›´åˆ¤æ–­
                
                if (type === 'mixed') {
                    checkbox.checked = true;
                } else if (type === 'hiragana') {
                    checkbox.checked = isHiraganaGroup;
                } else if (type === 'katakana') {
                    checkbox.checked = !isHiraganaGroup;
                }
            });

            // å¦‚æœå¯ç”¨äº†é™åˆ¶æ¨¡å¼ï¼Œåˆ™æ ¹æ®é€‰ä¸­çš„åˆ†ç»„æ›´æ–°å‡ååˆ—è¡¨
            if (learningModeCheckbox.checked) {
                updateKanaGroups();
            } else {
                shuffledKana = shuffleArray(allKana);
                currentIndex = 0;
                init();
            }
        });

        // é™åˆ¶æ¨¡å¼å¼€å…³
        learningModeCheckbox.addEventListener('change', () => {
            kanaGroupsContainer.style.display = learningModeCheckbox.checked ? 'block' : 'none';
            if (learningModeCheckbox.checked) {
                updateKanaGroups();
            } else {
                const type = practiceTypeSelect.value;
                if (type === 'hiragana') {
                    allKana = [...hiragana];
                } else if (type === 'katakana') {
                    allKana = [...katakana];
                } else {
                    allKana = [...hiragana, ...katakana];
                }
                shuffledKana = shuffleArray(allKana);
                currentIndex = 0;
                init();
            }
        });

        // ç›‘å¬å‡ååˆ†ç»„å¤é€‰æ¡†çš„å˜åŒ–
        document.querySelector('.kana-groups').addEventListener('change', updateKanaGroups);

        // è°ƒæ•´é€æ˜åº¦
        opacityInput.addEventListener('input', () => {
            kanaOpacity = opacityInput.value / 100;
            opacityValue.textContent = opacityInput.value;
            ctx.clearRect(0, 0, canvas.width, canvas.height); // æ¸…ç©ºç”»å¸ƒ
            drawGrid(); // é‡æ–°ç»˜åˆ¶ç”°å­—æ ¼
            drawKana(currentKana); // é‡æ–°ç»˜åˆ¶å‡å
        });

        // è°ƒæ•´é¢œè‰²
        colorInput.addEventListener('input', () => {
            kanaColor = colorInput.value;
            ctx.clearRect(0, 0, canvas.width, canvas.height); // æ¸…ç©ºç”»å¸ƒ
            drawGrid(); // é‡æ–°ç»˜åˆ¶ç”°å­—æ ¼
            drawKana(currentKana); // é‡æ–°ç»˜åˆ¶å‡å
        });

        // è°ƒæ•´å­—ä½“
        fontSelect.addEventListener('change', () => {
            const selectedFont = fontSelect.value;
            document.body.style.fontFamily = `"${selectedFont}", sans-serif`; // æ›´æ–°å…¨å±€å­—ä½“
            ctx.clearRect(0, 0, canvas.width, canvas.height); // æ¸…ç©ºç”»å¸ƒ
            drawGrid(); // é‡æ–°ç»˜åˆ¶ç”°å­—æ ¼
            drawKana(currentKana); // é‡æ–°ç»˜åˆ¶å‡å
        });
        document.addEventListener('DOMContentLoaded', () => {
            initJapaneseVoice();
            // åˆ›å»ºå¹¶æ˜¾ç¤ºæ°”æ³¡æç¤º
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.textContent = 'è®¾ç½®åœ¨è¿™é‡Œ';
            document.body.appendChild(tooltip);
            
            // å»¶è¿Ÿæ˜¾ç¤ºæ°”æ³¡ï¼Œæ·»åŠ æ·¡å…¥æ•ˆæœ
            setTimeout(() => {
                tooltip.style.opacity = '1';
            }, 500);

            // ç‚¹å‡»ä»»æ„ä½ç½®å…³é—­æ°”æ³¡
            document.addEventListener('click', () => {
                tooltip.style.opacity = '0';
                // ç­‰å¾…åŠ¨ç”»å®Œæˆåç§»é™¤å…ƒç´ 
                setTimeout(() => {
                    tooltip.remove();
                }, 300);
            }, { once: true });
        });
        // ç¡®ä¿å­—ä½“åŠ è½½å®Œæˆåå†åˆå§‹åŒ–ç”»æ¿
        document.fonts.ready.then(() => {
            init();
        });
                const showRomajiCheckbox = document.getElementById('show-romaji');

        // æ˜¾ç¤ºç½—é©¬éŸ³
        function displayRomaji(kana) {
            romajiDisplay.textContent = showRomajiCheckbox.checked ? (romaji[kana] || '') : '';
        }

        // è·å–æµ‹è¯•æ¨¡å¼å¤é€‰æ¡†å’Œæ¸…é™¤æŒ‰é’®
        const testModeCheckbox = document.getElementById('test-mode');
        const eraserButton = document.getElementById('eraser');

        // å­˜å‚¨åŸå§‹è®¾ç½®çŠ¶æ€
        let originalSettings = {
            showRomaji: true,
            speak: true
        };

        // ç›‘å¬æµ‹è¯•æ¨¡å¼å˜åŒ–
        testModeCheckbox.addEventListener('change', () => {
            if (testModeCheckbox.checked) {
                // ä¿å­˜å½“å‰è®¾ç½®
                originalSettings.showRomaji = showRomajiCheckbox.checked;
                originalSettings.speak = speakCheckbox.checked;

                // å¯ç”¨æµ‹è¯•æ¨¡å¼ï¼šéšè—ç½—é©¬éŸ³ã€å…³é—­æœ—è¯»ã€éšè—æ¸…é™¤æŒ‰é’®
                showRomajiCheckbox.checked = false;
                speakCheckbox.checked = false;
                eraserButton.style.display = 'none';

                // ç¦ç”¨æ˜¾ç¤ºè®¾ç½®é€‰é¡¹
                showRomajiCheckbox.disabled = true;
                speakCheckbox.disabled = true;
            } else {
                // æ¢å¤åŸå§‹è®¾ç½®
                showRomajiCheckbox.checked = originalSettings.showRomaji;
                speakCheckbox.checked = originalSettings.speak;
                eraserButton.style.display = 'block';

                // å¯ç”¨æ˜¾ç¤ºè®¾ç½®é€‰é¡¹
                showRomajiCheckbox.disabled = false;
                speakCheckbox.disabled = false;
            }
            // æ›´æ–°æ˜¾ç¤º
            displayRomaji(currentKana);
        });

        // ç›‘å¬ç½—é©¬éŸ³æ˜¾ç¤ºé€‰é¡¹çš„å˜åŒ–
        showRomajiCheckbox.addEventListener('change', () => {
            displayRomaji(currentKana);
        });
    </script>
</body>
</html>
