
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂÅáÂêç‰π¶ÂÜôÁªÉ‰π†</title>
    <!-- ÂºïÂÖ• Noto Sans JP Â≠ó‰Ωì -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/earlyaccess/kokoro.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/earlyaccess/hannari.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@200&display=swap" rel="stylesheet">
    <style>
        /* ÂÖ®Â±ÄÂ≠ó‰ΩìËÆæÁΩÆ‰∏∫ Noto Sans JP */
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            font-family: "Kokoro", sans-serif;
            font-optical-sizing: auto;
            font-weight: 200;
            font-style: normal;
            touch-action: none; /* Á¶ÅÊ≠¢ÈªòËÆ§Ëß¶Êë∏Ë°å‰∏∫ */
        }

        #canvas {
            border: 1px solid #000;
            background-color: #fff;
            margin-bottom: 20px;
            touch-action: none; /* Á¶ÅÊ≠¢ÈªòËÆ§Ëß¶Êë∏Ë°å‰∏∫ */
            cursor: default; /* ‰øÆÂ§çÂçÅÂ≠óÂÖâÊ†áÈóÆÈ¢ò */
        }

        #settings-menu {
            display: none;
            position: absolute;
            top: 60px;
            right: 20px;
            background-color: white;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            min-width: 300px;
            z-index: 1000;
        }

        .settings-section {
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .settings-section-title {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .kana-type-options {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 40px;  /* Â¢ûÂä†Â∫ïÈÉ®Èó¥Ë∑ù */
        }

        #kana-history {
            font-size: 24px;
            margin: 30px 0;  /* Â¢ûÂä†‰∏ä‰∏ãÈó¥Ë∑ù */
            padding: 15px;   /* Â¢ûÂä†ÂÜÖÈÉ®Èó¥Ë∑ù */
            text-align: center;
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            max-width: 800px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            backdrop-filter: blur(5px);
        }

        button {
            padding: 10px 20px;
            font-size: 24px;
            cursor: pointer;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
        }

        button:hover {
            background-color: #0056b3;
        }

        #romaji {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        #kana-history {
            font-size: 24px;
            margin-bottom: 10px;
            text-align: center;
            display: flex;
            gap: 5px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .kana-block {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            margin: 4px;
            background-color: #ffffff;
            border-radius: 8px;
            cursor: pointer;
            min-width: 30px;
            min-height: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            font-size: 20px;
        }

        .kana-block:hover {
            background-color: #f8f8f8;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        .practice-link {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            backdrop-filter: blur(5px);
            text-decoration: none;
            color: #666;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .practice-link:hover {
            background-color: rgba(255, 255, 255, 0.8);
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        #kana-history {
            font-size: 24px;
            margin: 20px 0;
            padding: 10px;
            text-align: center;
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            max-width: 800px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            backdrop-filter: blur(5px);
        }
        /* ÁâàÊú¨Âè∑ */
        .version {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 12px;
            color: #666;
            z-index: 100;
        }
        .tooltip {
            position: absolute;
            top: 45px;
            right: 80px;
            background-color: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            white-space: nowrap;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -6px;
            transform: translateY(-50%);
            border-width: 6px 0 6px 6px;
            border-style: solid;
            border-color: transparent transparent transparent #333;
        }

        #settings-icon {
            position: absolute;
            top: 35px;
            right: 35px;
            font-size: 35px;
            cursor: pointer;
        }

        #settings-menu {
            display: none;
            position: absolute;
            top: 60px;
            right: 20px;
            background-color: white;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #settings-menu label {
            display: block;
        }

        #settings-menu input[type="range"] {
            width: 100%;
        }

        .inline {
            display: flex;
            align-items: center;
            gap: 10px;
            min-height: 32px;
        }

        .inline label {
            display: flex;
            align-items: center;
            margin-bottom: 0;
            min-height: 24px;
        }

        .inline input[type="checkbox"] {
            margin: 0;
            width: 16px;
            height: 16px;
            vertical-align: middle;
        }

        .inline select {
            padding: 8px 32px 8px 12px;
            border-radius: 6px;
            border: 1px solid #ccc;
            background-color: #fff;
            font-size: 14px;
            color: #333;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .inline select:hover {
            border-color: #666;
        }

        .inline select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }

        .kana-groups {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 10px;
            max-width: 500px;
        }

        .kana-groups label {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            padding: 8px;
            border-radius: 4px;
            background-color: #f8f8f8;
            min-height: 24px;
        }

        .kana-groups input[type="checkbox"] {
            margin: 0;
            vertical-align: middle;
        }
        /* ÊúÄËøëÂá∫Áé∞ÁöÑÂÅáÂêçÊèêÁ§∫Ê∞îÊ≥°Ê†∑Âºè */
        .romaji-tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 16px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        @media (max-width: 600px) {
            .kana-groups {
                grid-template-columns: repeat(3, 1fr);
            }
            /* 
            .buttons {
                flex-direction: column;
            }
            */
        }


    </style>
</head>
<body>
    <div id="romaji"></div>
    <canvas id="canvas" width="200" height="200"></canvas>
    <div class="buttons">
        <button id="speak-again">üì¢</button>
        <button id="eraser">‚ùå</button>
        <button id="next">‚≠ïÔ∏è</button>
    </div>
    <div id="kana-history"></div><!-- ËÆ∞ÂΩïÊúÄÂêé 10 ‰∏™ÂÅáÂêç -->
    <a href="/dictation.html" class="practice-link">ÁúãÈü≥ÂÜôÂÅáÂêç</a> 

    <!-- ÈΩøËΩÆÂõæÊ†á -->
    <div id="settings-icon">üîß</div>

    <!-- ËÆæÁΩÆËèúÂçï -->
    <div id="settings-menu">
        <div class="settings-section">
            <div class="settings-section-title">Âá∫Áé∞Ê®°Âºè</div>
            <div class="inline">
                <select id="practice-type">
                    <option value="mixed">Ê∑∑ÂêàÊ®°Âºè</option>
                    <option value="hiragana">Âπ≥ÂÅáÂêç</option>
                    <option value="katakana">ÁâáÂÅáÂêç</option>
                </select>
            </div>
        </div>
    
        <div class="settings-section">
            <div class="settings-section-title">ÈôêÂà∂Ê®°Âºè</div>
            <div class="inline">
                <input type="checkbox" id="learning-mode">
                <label for="learning-mode">ÂêØÁî®ÈôêÂà∂Ê®°Âºè</label>
            </div>
            <div id="kana-groups-container" style="display: none;">

                <div class="kana-groups">
                    <!-- ÂÅáÂêçÂàÜÁªÑÂ§çÈÄâÊ°ÜÂ∞ÜÈÄöËøá JavaScript Âä®ÊÄÅÂä†ËΩΩ -->
                </div>
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-section-title">ÊµãËØïÊ®°Âºè</div>
            <div class="inline">
                <input type="checkbox" id="test-mode">
                <label for="test-mode">ÂêØÁî®ÊãºËØªÊµãËØï</label>
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-section-title">ÊòæÁ§∫ËÆæÁΩÆ</div>
            <div class="inline">
                <label for="show-romaji">ÊòæÁ§∫ÁΩóÈ©¨Èü≥Ôºö</label>
                <input type="checkbox" id="show-romaji" checked>
            </div>
            <div class="inline">
                <label for="speak">ÊúóËØªÂÅáÂêçÔºö</label>
                <input type="checkbox" id="speak" checked>
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-section-title">Â≠ó‰ΩìËÆæÁΩÆ</div>
            <div class="inline">
                <label for="font-select">ÈÄâÊã©Â≠ó‰ΩìÔºö</label>
                <select id="font-select">
                    <option value="Kokoro">Kokoro</option>
                    <option value="Hannari">Hannari</option>
                    <option value="Noto Sans JP">Noto Sans JP</option>
                </select>
            </div>
            <label for="opacity">ÂÅáÂêçÈÄèÊòéÂ∫¶Ôºö<span id="opacity-value">20</span>%</label>
            <input type="range" id="opacity" min="0" max="100" value="20">
            <div class="inline">
                <label for="color">ÂÅáÂêçÈ¢úËâ≤Ôºö</label>
                <input type="color" id="color" value="#000000">
            </div>
        </div>
    </div>
    <div class="version">ver.0.2.6</div>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const romajiDisplay = document.getElementById('romaji');
        const kanaHistoryDisplay = document.getElementById('kana-history');
        const settingsIcon = document.getElementById('settings-icon');
        const settingsMenu = document.getElementById('settings-menu');
        const practiceTypeSelect = document.getElementById('practice-type');
        const learningModeCheckbox = document.getElementById('learning-mode');
        const kanaGroupsContainer = document.getElementById('kana-groups-container');
        const opacityInput = document.getElementById('opacity');
        const opacityValue = document.getElementById('opacity-value');
        const colorInput = document.getElementById('color');
        const speakCheckbox = document.getElementById('speak');
        const fontSelect = document.getElementById('font-select');

        // Áî∞Â≠óÊ†ºÁöÑÂ§ßÂ∞è
        const gridSize = 200;
        const cellSize = gridSize / 2;

        // Âπ≥ÂÅáÂêçÂíåÁâáÂÅáÂêçÊï∞ÁªÑ
        const hiragana = [
            '„ÅÇ', '„ÅÑ', '„ÅÜ', '„Åà', '„Åä',
            '„Åã', '„Åç', '„Åè', '„Åë', '„Åì',
            '„Åï', '„Åó', '„Åô', '„Åõ', '„Åù',
            '„Åü', '„Å°', '„Å§', '„Å¶', '„Å®',
            '„Å™', '„Å´', '„Å¨', '„Å≠', '„ÅÆ',
            '„ÅØ', '„Å≤', '„Åµ', '„Å∏', '„Åª',
            '„Åæ', '„Åø', '„ÇÄ', '„ÇÅ', '„ÇÇ',
            '„ÇÑ', '„ÇÜ', '„Çà',
            '„Çâ', '„Çä', '„Çã', '„Çå', '„Çç',
            '„Çè', '„Çí', '„Çì'
        ];
        const katakana = [
            '„Ç¢', '„Ç§', '„Ç¶', '„Ç®', '„Ç™',
            '„Ç´', '„Ç≠', '„ÇØ', '„Ç±', '„Ç≥',
            '„Çµ', '„Ç∑', '„Çπ', '„Çª', '„ÇΩ',
            '„Çø', '„ÉÅ', '„ÉÑ', '„ÉÜ', '„Éà',
            '„Éä', '„Éã', '„Éå', '„Éç', '„Éé',
            '„Éè', '„Éí', '„Éï', '„Éò', '„Éõ',
            '„Éû', '„Éü', '„É†', '„É°', '„É¢',
            '„É§', '„É¶', '„É®',
            '„É©', '„É™', '„É´', '„É¨', '„É≠',
            '„ÉØ', '„É≤', '„É≥'
        ];

        // Âπ≥ÂÅáÂêçÂíåÁâáÂÅáÂêçÂØπÂ∫îÁöÑÁΩóÈ©¨Èü≥
        const romaji = {
            '„ÅÇ': 'a', '„ÅÑ': 'i', '„ÅÜ': 'u', '„Åà': 'e', '„Åä': 'o',
            '„Åã': 'ka', '„Åç': 'ki', '„Åè': 'ku', '„Åë': 'ke', '„Åì': 'ko',
            '„Åï': 'sa', '„Åó': 'shi', '„Åô': 'su', '„Åõ': 'se', '„Åù': 'so',
            '„Åü': 'ta', '„Å°': 'chi', '„Å§': 'tsu', '„Å¶': 'te', '„Å®': 'to',
            '„Å™': 'na', '„Å´': 'ni', '„Å¨': 'nu', '„Å≠': 'ne', '„ÅÆ': 'no',
            '„ÅØ': 'ha', '„Å≤': 'hi', '„Åµ': 'fu', '„Å∏': 'he', '„Åª': 'ho',
            '„Åæ': 'ma', '„Åø': 'mi', '„ÇÄ': 'mu', '„ÇÅ': 'me', '„ÇÇ': 'mo',
            '„ÇÑ': 'ya', '„ÇÜ': 'yu', '„Çà': 'yo',
            '„Çâ': 'ra', '„Çä': 'ri', '„Çã': 'ru', '„Çå': 're', '„Çç': 'ro',
            '„Çè': 'wa', '„Çí': 'wo', '„Çì': 'n',
            '„Ç¢': 'a', '„Ç§': 'i', '„Ç¶': 'u', '„Ç®': 'e', '„Ç™': 'o',
            '„Ç´': 'ka', '„Ç≠': 'ki', '„ÇØ': 'ku', '„Ç±': 'ke', '„Ç≥': 'ko',
            '„Çµ': 'sa', '„Ç∑': 'shi', '„Çπ': 'su', '„Çª': 'se', '„ÇΩ': 'so',
            '„Çø': 'ta', '„ÉÅ': 'chi', '„ÉÑ': 'tsu', '„ÉÜ': 'te', '„Éà': 'to',
            '„Éä': 'na', '„Éã': 'ni', '„Éå': 'nu', '„Éç': 'ne', '„Éé': 'no',
            '„Éè': 'ha', '„Éí': 'hi', '„Éï': 'fu', '„Éò': 'he', '„Éõ': 'ho',
            '„Éû': 'ma', '„Éü': 'mi', '„É†': 'mu', '„É°': 'me', '„É¢': 'mo',
            '„É§': 'ya', '„É¶': 'yu', '„É®': 'yo',
            '„É©': 'ra', '„É™': 'ri', '„É´': 'ru', '„É¨': 're', '„É≠': 'ro',
            '„ÉØ': 'wa', '„É≤': 'wo', '„É≥': 'n'
        };

        // ÂÅáÂêçÂàÜÁªÑ
        const kanaGroups = {
            '„ÅÇË°å': ['„ÅÇ', '„ÅÑ', '„ÅÜ', '„Åà', '„Åä'],
            '„ÅãË°å': ['„Åã', '„Åç', '„Åè', '„Åë', '„Åì'],
            '„ÅïË°å': ['„Åï', '„Åó', '„Åô', '„Åõ', '„Åù'],
            '„ÅüË°å': ['„Åü', '„Å°', '„Å§', '„Å¶', '„Å®'],
            '„Å™Ë°å': ['„Å™', '„Å´', '„Å¨', '„Å≠', '„ÅÆ'],
            '„ÅØË°å': ['„ÅØ', '„Å≤', '„Åµ', '„Å∏', '„Åª'],
            '„ÅæË°å': ['„Åæ', '„Åø', '„ÇÄ', '„ÇÅ', '„ÇÇ'],
            '„ÇÑË°å': ['„ÇÑ', '„ÇÜ', '„Çà'],
            '„ÇâË°å': ['„Çâ', '„Çä', '„Çã', '„Çå', '„Çç'],
            '„ÇèË°å': ['„Çè', '„Çí', '„Çì'],
            '„Ç¢Ë°å': ['„Ç¢', '„Ç§', '„Ç¶', '„Ç®', '„Ç™'],
            '„Ç´Ë°å': ['„Ç´', '„Ç≠', '„ÇØ', '„Ç±', '„Ç≥'],
            '„ÇµË°å': ['„Çµ', '„Ç∑', '„Çπ', '„Çª', '„ÇΩ'],
            '„ÇøË°å': ['„Çø', '„ÉÅ', '„ÉÑ', '„ÉÜ', '„Éà'],
            '„ÉäË°å': ['„Éä', '„Éã', '„Éå', '„Éç', '„Éé'],
            '„ÉèË°å': ['„Éè', '„Éí', '„Éï', '„Éò', '„Éõ'],
            '„ÉûË°å': ['„Éû', '„Éü', '„É†', '„É°', '„É¢'],
            '„É§Ë°å': ['„É§', '„É¶', '„É®'],
            '„É©Ë°å': ['„É©', '„É™', '„É´', '„É¨', '„É≠'],
            '„ÉØË°å': ['„ÉØ', '„É≤', '„É≥']
        };

        // ÂΩìÂâçÊòæÁ§∫ÁöÑÂÅáÂêç
        let currentKana = '';

        // ÂÅáÂêçÈÄèÊòéÂ∫¶ÔºàÈªòËÆ§20%Ôºâ
        let kanaOpacity = 0.2;

        // ÂÅáÂêçÈ¢úËâ≤ÔºàÈªòËÆ§ÈªëËâ≤Ôºâ
        let kanaColor = '#000000';

        // ËÆ∞ÂΩïÊúÄÂêé 10 ‰∏™ÂÅáÂêç
        let kanaHistory = [];

        // ÊâÄÊúâÂÅáÂêçÊï∞ÁªÑ
        let allKana = [...hiragana, ...katakana];

        // Êâì‰π±Êï∞ÁªÑÈ°∫Â∫èÔºàFisher-Yates ÁÆóÊ≥ïÔºâ
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Êâì‰π±ÂêéÁöÑÂÅáÂêçÊï∞ÁªÑ
        let shuffledKana = shuffleArray(allKana);

        // ÂΩìÂâçÂÅáÂêçÁ¥¢Âºï
        let currentIndex = 0;

        // ËÆæÁΩÆÂéÜÂè≤ËÆ∞ÂΩïÊúÄÂ§ßÈïøÂ∫¶
        let maxHistoryLength = window.innerHeight > window.innerWidth ? 6 : 10;

        // Ê£ÄÊµãËÆæÂ§áÊñπÂêëÂπ∂ËÆæÁΩÆÂéÜÂè≤ËÆ∞ÂΩïÈïøÂ∫¶
        function setMaxHistoryLength() {
            maxHistoryLength = window.innerHeight > window.innerWidth ? 6 : 10;
            // Â¶ÇÊûúÂΩìÂâçÂéÜÂè≤ËÆ∞ÂΩïË∂ÖËøáÊñ∞ÁöÑÊúÄÂ§ßÈïøÂ∫¶ÔºåÂàôË£ÅÂâ™
            while (kanaHistory.length > maxHistoryLength) {
                kanaHistory.shift();
            }
            // Êõ¥Êñ∞ÊòæÁ§∫
            kanaHistoryDisplay.innerHTML = kanaHistory
                .map(k => `<span class="kana-block">${k}</span>`)
                .join('');
        }

        // È°µÈù¢Âä†ËΩΩÊó∂ËÆæÁΩÆÂéÜÂè≤ËÆ∞ÂΩïÈïøÂ∫¶
        document.addEventListener('DOMContentLoaded', setMaxHistoryLength);

        // Êõ¥Êñ∞ÂÅáÂêçËÆ∞ÂΩï
        function updateKanaHistory(kana) {
            kanaHistory.push(kana);
            if (kanaHistory.length > maxHistoryLength) {
                kanaHistory.shift();
            }
            
            kanaHistoryDisplay.innerHTML = kanaHistory
                .map(k => `<span class="kana-block" data-kana="${k}">${k}</span>`)
                .join('');

            // ‰∏∫ÊØè‰∏™ÂÅáÂêçÂùóÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨
            document.querySelectorAll('.kana-block').forEach(block => {
                block.addEventListener('mouseenter', showRomajiTooltip);
                block.addEventListener('mouseleave', hideRomajiTooltip);
                block.addEventListener('touchstart', handleTouch);
                // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÁõëÂê¨Âô®Êí≠ÊîæËØ≠Èü≥
                block.addEventListener('click', (e) => {
                    const kana = e.target.dataset.kana;
                    speakKana(kana);
                });
            });
        }
        // ÊòæÁ§∫ÁΩóÈ©¨Èü≥Ê∞îÊ≥°
        function showRomajiTooltip(e) {
            const kana = e.target.dataset.kana;
            const romajiText = romaji[kana];
            
            // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑÊ∞îÊ≥°
            const existingTooltip = document.querySelector('.romaji-tooltip');
            if (existingTooltip) {
                existingTooltip.remove();
            }

            // ÂàõÂª∫Êñ∞Ê∞îÊ≥°
            const tooltip = document.createElement('div');
            tooltip.className = 'romaji-tooltip';
            tooltip.textContent = romajiText;
            document.body.appendChild(tooltip);

            // ËÆ°ÁÆó‰ΩçÁΩÆ
            const rect = e.target.getBoundingClientRect();
            tooltip.style.left = `${rect.left + (rect.width - tooltip.offsetWidth) / 2}px`;
            tooltip.style.top = `${rect.top - tooltip.offsetHeight - 8}px`;

            // ÊòæÁ§∫Ê∞îÊ≥°
            requestAnimationFrame(() => {
                tooltip.style.opacity = '1';
            });

            // 1ÁßíÂêéËá™Âä®ÈöêËóè
            setTimeout(() => {
                tooltip.style.opacity = '0';
                setTimeout(() => tooltip.remove(), 300);
            }, 1000);
        }

        function hideRomajiTooltip() {
            const tooltip = document.querySelector('.romaji-tooltip');
            if (tooltip) {
                tooltip.style.opacity = '0';
                setTimeout(() => tooltip.remove(), 300);
            }
        }

        function handleTouch(e) {
            e.preventDefault();
            showRomajiTooltip(e);
        }

        // ÊúóËØªÂÅáÂêç
        // ËØ≠Èü≥ÂêàÊàêÈòüÂàó
        let speechQueue = [];
        let isSpeaking = false;

        // ÊúóËØªÂÅáÂêç
           // ÂàùÂßãÂåñËØ≠Èü≥ÂêàÊàê
           let voices = [];
        let japaneseVoice = null;

        // Á≠âÂæÖËØ≠Èü≥Âä†ËΩΩ
        function loadVoices() {
            return new Promise((resolve) => {
                voices = speechSynthesis.getVoices();
                if (voices.length > 0) {
                    resolve();
                } else {
                    speechSynthesis.addEventListener('voiceschanged', () => {
                        voices = speechSynthesis.getVoices();
                        resolve();
                    }, { once: true });
                }
            });
        }

        // Ëé∑ÂèñÊó•ËØ≠ËØ≠Èü≥
        async function initJapaneseVoice() {
            await loadVoices();
            japaneseVoice = voices.find(voice => voice.lang.includes('ja'));
        }

        // ÊúóËØªÂÅáÂêç
        async function speakKana(kana) {
            if (!speakCheckbox.checked || !('speechSynthesis' in window)) return;

            try {
                // Á°Æ‰øùÂ∑≤Âä†ËΩΩÊó•ËØ≠ËØ≠Èü≥
                if (!japaneseVoice) {
                    await initJapaneseVoice();
                }

                // ÂèñÊ∂à‰πãÂâçÁöÑËØ≠Èü≥
                speechSynthesis.cancel();

                // ÂàõÂª∫Êñ∞ÁöÑËØ≠Èü≥ÂÆû‰æã
                const utterance = new SpeechSynthesisUtterance(kana);
                utterance.voice = japaneseVoice;
                utterance.lang = 'ja-JP';
                utterance.rate = 0.8;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;

                // ‰ΩøÁî® Promise ÂåÖË£ÖËØ≠Èü≥Êí≠Êîæ
                await new Promise((resolve, reject) => {
                    utterance.onend = resolve;
                    utterance.onerror = reject;
                    speechSynthesis.speak(utterance);//ÊîØÊè¥SafariÁöÑÂÖ≥ÈîÆÊâÄÂú®Ôºü
                });
            } catch (error) {
                console.error('ËØ≠Èü≥ÂêàÊàêÈîôËØØ:', error);
            }
        }

        // ÁªòÂà∂Áî∞Â≠óÊ†º
        function drawGrid() {
            ctx.strokeStyle = '#ffb3b3'; // ÊµÖÁ∫¢Ëâ≤
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]); // ËÆæÁΩÆËôöÁ∫øÊ†∑ÂºèÔºå5ÂÉèÁ¥†Á∫øÊÆµÔºå5ÂÉèÁ¥†Èó¥Èöî

            // ÁªòÂà∂Â§ñÊ°Ü
            ctx.strokeRect(0, 0, gridSize, gridSize);

            // ÁªòÂà∂Ê®™Á∫ø
            ctx.beginPath();
            ctx.moveTo(0, cellSize);
            ctx.lineTo(gridSize, cellSize);
            ctx.stroke();

            // ÁªòÂà∂Á´ñÁ∫ø
            ctx.beginPath();
            ctx.moveTo(cellSize, 0);
            ctx.lineTo(cellSize, gridSize);
            ctx.stroke();

            // ÈáçÁΩÆËôöÁ∫øÊ†∑Âºè
            ctx.setLineDash([]);
        }

        // ÁªòÂà∂ÂÅáÂêç
        function drawKana(kana) {
            const selectedFont = fontSelect.value; // Ëé∑ÂèñÁî®Êà∑ÈÄâÊã©ÁöÑÂ≠ó‰Ωì
            ctx.font = `200 150px "${selectedFont}", sans-serif`; // ‰ΩøÁî®Áî®Êà∑ÈÄâÊã©ÁöÑÂ≠ó‰Ωì
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = `rgba(${parseInt(kanaColor.slice(1, 3), 16)}, ${parseInt(kanaColor.slice(3, 5), 16)}, ${parseInt(kanaColor.slice(5, 7), 16)}, ${kanaOpacity})`;
            ctx.fillText(kana, gridSize / 2, gridSize / 2);
        }

        // ÊòæÁ§∫ÁΩóÈ©¨Èü≥
        function displayRomaji(kana) {
            romajiDisplay.textContent = romaji[kana] || '';
        }

        // ÂàùÂßãÂåñÁîªÊùø
        function init() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Ê∏ÖÁ©∫ÁîªÂ∏É
            drawGrid();
            currentKana = shuffledKana[currentIndex]; // Ëé∑ÂèñÂΩìÂâçÂÅáÂêç
            drawKana(currentKana);
            displayRomaji(currentKana);
            updateKanaHistory(currentKana); // Êõ¥Êñ∞ÂÅáÂêçËÆ∞ÂΩï
            speakKana(currentKana); // ÊúóËØªÂÅáÂêç
            currentIndex = (currentIndex + 1) % shuffledKana.length; // Êõ¥Êñ∞Á¥¢Âºï

            // Â¶ÇÊûúÊâÄÊúâÂÅáÂêçÂ∑≤ËæìÂá∫‰∏ÄÊ¨°ÔºåÈáçÊñ∞Êâì‰π±È°∫Â∫è
            if (currentIndex === 0) {
                shuffledKana = shuffleArray(allKana);
            }
        }

        // Ëé∑ÂèñËß¶Êë∏ÁÇπÁöÑÂùêÊ†á
        function getTouchPos(event) {
            const rect = canvas.getBoundingClientRect();
            const touch = event.touches[0];
            return {
                x: touch.clientX - rect.left,
                y: touch.clientY - rect.top
            };
        }

        // Èº†Ê†áÂíåËß¶Êë∏‰∫ã‰ª∂Â§ÑÁêÜ
        let isDrawing = false;

        // Èº†Ê†á‰∫ã‰ª∂
        canvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        });

        canvas.addEventListener('mousemove', (e) => {
            if (isDrawing) {
                ctx.lineWidth = 5; // ÁîªÁ¨îÁ≤óÁªÜ
                ctx.strokeStyle = '#000'; // ÁîªÁ¨îÈ¢úËâ≤
                ctx.lineCap = 'round'; // ÁîªÁ¨îÂúÜÊ∂¶
                ctx.lineJoin = 'round'; // ËøûÊé•Â§ÑÂúÜÊ∂¶
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.stroke();
            }
        });

        canvas.addEventListener('mouseup', () => {
            isDrawing = false;
            ctx.closePath();
        });

        canvas.addEventListener('mouseleave', () => {
            isDrawing = false;
        });

        // Ëß¶Êë∏‰∫ã‰ª∂
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); // ÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫
            isDrawing = true;
            const pos = getTouchPos(e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault(); // ÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫
            if (isDrawing) {
                const pos = getTouchPos(e);
                ctx.lineWidth = 5; // ÁîªÁ¨îÁ≤óÁªÜ
                ctx.strokeStyle = '#000'; // ÁîªÁ¨îÈ¢úËâ≤
                ctx.lineCap = 'round'; // ÁîªÁ¨îÂúÜÊ∂¶
                ctx.lineJoin = 'round'; // ËøûÊé•Â§ÑÂúÜÊ∂¶
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            }
        });

        canvas.addEventListener('touchend', () => {
            isDrawing = false;
            ctx.closePath();
        });

        // Ëé∑ÂèñÊñ∞Â¢ûÁöÑÊúóËØªÊåâÈíÆ
        const speakAgainButton = document.getElementById('speak-again');
        // ‰∏∫ÊúóËØªÊåâÈíÆÊ∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
        speakAgainButton.addEventListener('click', () => {
            speakKana(currentKana); // ÈáçÊñ∞ÊúóËØªÂΩìÂâçÂÅáÂêç
        });

        // Ê©°ÁöÆÊì¶ÂäüËÉΩÔºö‰ªÖÊ∏ÖÈô§ÊèèÁîªÂÜÖÂÆπÔºå‰∏çÊõ¥Êñ∞ÂÅáÂêç
        document.getElementById('eraser').addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Ê∏ÖÁ©∫ÁîªÂ∏É
            drawGrid(); // ÈáçÊñ∞ÁªòÂà∂Áî∞Â≠óÊ†º
            drawKana(currentKana); // ÈáçÊñ∞ÁªòÂà∂ÂΩìÂâçÂÅáÂêç
        });

        // ‰∏ã‰∏Ä‰∏™ÂÅáÂêçÂäüËÉΩ
        document.getElementById('next').addEventListener('click', () => {
            init(); // ÈáçÊñ∞ÂàùÂßãÂåñÁîªÂ∏É
        });

        // ËÆæÁΩÆËèúÂçïÊòæÁ§∫/ÈöêËóè
        settingsIcon.addEventListener('click', (e) => {
            e.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°
            settingsMenu.style.display = settingsMenu.style.display === 'block' ? 'none' : 'block';
        });
    
        // Ëé∑ÂèñÂÖ®ÈÄâÂ§çÈÄâÊ°Ü
        const selectAllCheckbox = document.getElementById('select-all');


        // ‰øÆÊîπÂÅáÂêçÂàÜÁªÑÂ§çÈÄâÊ°ÜÁöÑÂèòÂåñÁõëÂê¨Ôºå‰ΩøÂÖ∂ÂêåÊ≠•ÂÖ®ÈÄâÊ°ÜÁä∂ÊÄÅ
        document.querySelector('.kana-groups').addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.kana-groups input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
            selectAllCheckbox.checked = allChecked;
            updateKanaGroups();
        });

        // ÁÇπÂáªÈ°µÈù¢ÂÖ∂‰ªñÂå∫ÂüüÂÖ≥Èó≠ËÆæÁΩÆËèúÂçï
        document.addEventListener('click', () => {
            settingsMenu.style.display = 'none';
        });

        // ÈòªÊ≠¢ËÆæÁΩÆËèúÂçïÂÜÖÈÉ®ÁöÑÁÇπÂáª‰∫ã‰ª∂ÂÜíÊ≥°
        settingsMenu.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // Âä†ËΩΩÂÅáÂêçÂàÜÁªÑÂ§çÈÄâÊ°Ü
        function loadKanaGroups() {
            const kanaGroupsDiv = document.querySelector('.kana-groups');
            kanaGroupsDiv.innerHTML = ''; // Ê∏ÖÁ©∫ÈÄâÈ°π
            for (const group in kanaGroups) {
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = group;
                checkbox.checked = true; // ÈªòËÆ§ÂÖ®ÈÄâ
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(group));
                kanaGroupsDiv.appendChild(label);
            }
        }

        // ÂàùÂßãÂåñÂÅáÂêçÂàÜÁªÑÂ§çÈÄâÊ°Ü
        loadKanaGroups();

        // ÈôêÂà∂Ê®°ÂºèÂºÄÂÖ≥
        learningModeCheckbox.addEventListener('change', () => {
            kanaGroupsContainer.style.display = learningModeCheckbox.checked ? 'block' : 'none';
            if (!learningModeCheckbox.checked) {
                allKana = [...hiragana, ...katakana]; // ÈáçÁΩÆ‰∏∫ÊâÄÊúâÂÅáÂêç
                shuffledKana = shuffleArray(allKana);
                currentIndex = 0;
                init();
            }
        });

        // Êõ¥Êñ∞ÂÅáÂêçÂàÜÁªÑ
        function updateKanaGroups() {
            const selectedGroups = Array.from(document.querySelectorAll('.kana-groups input:checked'))
                .map(checkbox => kanaGroups[checkbox.value])
                .flat();
            allKana = selectedGroups.length > 0 ? selectedGroups : [...hiragana, ...katakana];
            shuffledKana = shuffleArray(allKana);
            currentIndex = 0;
            init();
        }

        // ÁõëÂê¨ÂÅáÂêçÂàÜÁªÑÂ§çÈÄâÊ°ÜÁöÑÂèòÂåñ
        document.querySelector('.kana-groups').addEventListener('change', updateKanaGroups);

        // Ë∞ÉÊï¥ÁªÉ‰π†Á±ªÂûã
        practiceTypeSelect.addEventListener('change', () => {
            const type = practiceTypeSelect.value;
            
            // Ê†πÊçÆÈÄâÊã©ÁöÑÁ±ªÂûãËÆæÁΩÆÂÅáÂêçÂàóË°®
            if (type === 'hiragana') {
                allKana = [...hiragana];
            } else if (type === 'katakana') {
                allKana = [...katakana];
            } else {
                allKana = [...hiragana, ...katakana];
            }

            // Êõ¥Êñ∞ÈôêÂà∂Ê®°Âºè‰∏≠ÁöÑÈÄâÈ°π
            const checkboxes = document.querySelectorAll('.kana-groups input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                const groupName = checkbox.value;
                const isHiraganaGroup = groupName.match(/^[„ÅÇ-„Çì]/); // ‰ΩøÁî®Êó•ËØ≠Â≠óÁ¨¶ËåÉÂõ¥Âà§Êñ≠
                
                if (type === 'mixed') {
                    checkbox.checked = true;
                } else if (type === 'hiragana') {
                    checkbox.checked = isHiraganaGroup;
                } else if (type === 'katakana') {
                    checkbox.checked = !isHiraganaGroup;
                }
            });

            // Â¶ÇÊûúÂêØÁî®‰∫ÜÈôêÂà∂Ê®°ÂºèÔºåÂàôÊ†πÊçÆÈÄâ‰∏≠ÁöÑÂàÜÁªÑÊõ¥Êñ∞ÂÅáÂêçÂàóË°®
            if (learningModeCheckbox.checked) {
                updateKanaGroups();
            } else {
                shuffledKana = shuffleArray(allKana);
                currentIndex = 0;
                init();
            }
        });

        // ÈôêÂà∂Ê®°ÂºèÂºÄÂÖ≥
        learningModeCheckbox.addEventListener('change', () => {
            kanaGroupsContainer.style.display = learningModeCheckbox.checked ? 'block' : 'none';
            if (learningModeCheckbox.checked) {
                updateKanaGroups();
            } else {
                const type = practiceTypeSelect.value;
                if (type === 'hiragana') {
                    allKana = [...hiragana];
                } else if (type === 'katakana') {
                    allKana = [...katakana];
                } else {
                    allKana = [...hiragana, ...katakana];
                }
                shuffledKana = shuffleArray(allKana);
                currentIndex = 0;
                init();
            }
        });

        // ÁõëÂê¨ÂÅáÂêçÂàÜÁªÑÂ§çÈÄâÊ°ÜÁöÑÂèòÂåñ
        document.querySelector('.kana-groups').addEventListener('change', updateKanaGroups);

        // Ë∞ÉÊï¥ÈÄèÊòéÂ∫¶
        opacityInput.addEventListener('input', () => {
            kanaOpacity = opacityInput.value / 100;
            opacityValue.textContent = opacityInput.value;
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Ê∏ÖÁ©∫ÁîªÂ∏É
            drawGrid(); // ÈáçÊñ∞ÁªòÂà∂Áî∞Â≠óÊ†º
            drawKana(currentKana); // ÈáçÊñ∞ÁªòÂà∂ÂÅáÂêç
        });

        // Ë∞ÉÊï¥È¢úËâ≤
        colorInput.addEventListener('input', () => {
            kanaColor = colorInput.value;
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Ê∏ÖÁ©∫ÁîªÂ∏É
            drawGrid(); // ÈáçÊñ∞ÁªòÂà∂Áî∞Â≠óÊ†º
            drawKana(currentKana); // ÈáçÊñ∞ÁªòÂà∂ÂÅáÂêç
        });

        // Ë∞ÉÊï¥Â≠ó‰Ωì
        fontSelect.addEventListener('change', () => {
            const selectedFont = fontSelect.value;
            document.body.style.fontFamily = `"${selectedFont}", sans-serif`; // Êõ¥Êñ∞ÂÖ®Â±ÄÂ≠ó‰Ωì
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Ê∏ÖÁ©∫ÁîªÂ∏É
            drawGrid(); // ÈáçÊñ∞ÁªòÂà∂Áî∞Â≠óÊ†º
            drawKana(currentKana); // ÈáçÊñ∞ÁªòÂà∂ÂÅáÂêç
        });
        document.addEventListener('DOMContentLoaded', () => {
            initJapaneseVoice();
            // ÂàõÂª∫Âπ∂ÊòæÁ§∫Ê∞îÊ≥°ÊèêÁ§∫
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.textContent = 'ËÆæÁΩÆÂú®ËøôÈáå';
            document.body.appendChild(tooltip);
            
            // Âª∂ËøüÊòæÁ§∫Ê∞îÊ≥°ÔºåÊ∑ªÂä†Ê∑°ÂÖ•ÊïàÊûú
            setTimeout(() => {
                tooltip.style.opacity = '1';
            }, 500);

            // ÁÇπÂáª‰ªªÊÑè‰ΩçÁΩÆÂÖ≥Èó≠Ê∞îÊ≥°
            document.addEventListener('click', () => {
                tooltip.style.opacity = '0';
                // Á≠âÂæÖÂä®ÁîªÂÆåÊàêÂêéÁßªÈô§ÂÖÉÁ¥†
                setTimeout(() => {
                    tooltip.remove();
                }, 300);
            }, { once: true });
        });
        // Á°Æ‰øùÂ≠ó‰ΩìÂä†ËΩΩÂÆåÊàêÂêéÂÜçÂàùÂßãÂåñÁîªÊùø
        document.fonts.ready.then(() => {
            init();
        });
                const showRomajiCheckbox = document.getElementById('show-romaji');

        // ÊòæÁ§∫ÁΩóÈ©¨Èü≥
        function displayRomaji(kana) {
            romajiDisplay.textContent = showRomajiCheckbox.checked ? (romaji[kana] || '') : '';
        }

        // Ëé∑ÂèñÊµãËØïÊ®°ÂºèÂ§çÈÄâÊ°ÜÂíåÊ∏ÖÈô§ÊåâÈíÆ
        const testModeCheckbox = document.getElementById('test-mode');
        const eraserButton = document.getElementById('eraser');

        // Â≠òÂÇ®ÂéüÂßãËÆæÁΩÆÁä∂ÊÄÅ
        let originalSettings = {
            showRomaji: true,
            speak: true
        };

        // ÁõëÂê¨ÊµãËØïÊ®°ÂºèÂèòÂåñ
        testModeCheckbox.addEventListener('change', () => {
            if (testModeCheckbox.checked) {
                // ‰øùÂ≠òÂΩìÂâçËÆæÁΩÆ
                originalSettings.showRomaji = showRomajiCheckbox.checked;
                originalSettings.speak = speakCheckbox.checked;

                // ÂêØÁî®ÊµãËØïÊ®°ÂºèÔºöÈöêËóèÁΩóÈ©¨Èü≥„ÄÅÂÖ≥Èó≠ÊúóËØª„ÄÅÈöêËóèÊ∏ÖÈô§ÊåâÈíÆ
                showRomajiCheckbox.checked = false;
                speakCheckbox.checked = false;
                eraserButton.style.display = 'none';

                // Á¶ÅÁî®ÊòæÁ§∫ËÆæÁΩÆÈÄâÈ°π
                showRomajiCheckbox.disabled = true;
                speakCheckbox.disabled = true;
            } else {
                // ÊÅ¢Â§çÂéüÂßãËÆæÁΩÆ
                showRomajiCheckbox.checked = originalSettings.showRomaji;
                speakCheckbox.checked = originalSettings.speak;
                eraserButton.style.display = 'block';

                // ÂêØÁî®ÊòæÁ§∫ËÆæÁΩÆÈÄâÈ°π
                showRomajiCheckbox.disabled = false;
                speakCheckbox.disabled = false;
            }
            // Êõ¥Êñ∞ÊòæÁ§∫
            displayRomaji(currentKana);
        });

        // ÁõëÂê¨ÁΩóÈ©¨Èü≥ÊòæÁ§∫ÈÄâÈ°πÁöÑÂèòÂåñ
        showRomajiCheckbox.addEventListener('change', () => {
            displayRomaji(currentKana);
        });
    </script>
</body>
</html>
